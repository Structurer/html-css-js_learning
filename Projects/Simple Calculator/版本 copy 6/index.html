<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸç”ŸJSç²¾å‡†è®¡ç®—å™¨ï¼ˆæ— è®¡ç®—é”™è¯¯æœ€ç»ˆç‰ˆï¼‰</title>
    <!-- ä¿ç•™ä½ å–œæ¬¢çš„åŸæ ·å¼ -->
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f4f4f4;
        }
        .calculator {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            max-width: 400px;
        }
        .display {
            width: 100%;
            height: 60px;
            background-color: #333;
            color: #fff;
            font-size: 32px;
            text-align: right;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            box-sizing: border-box;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-gap: 10px;
        }
        .buttons button {
            width: 100%;
            padding: 20px;
            font-size: 24px;
            border: none;
            border-radius: 5px;
            background-color: #eee;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .buttons button:hover {
            background-color: #ccc;
        }
        .buttons button.operation {
            background-color: #ff8c00;
            color: white;
        }
        .buttons button:active {
            transform: scale(0.98);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="calculator">
        <div class="display" id="display">0</div>
        <div class="buttons">
            <button onclick="handleInput('(')">(</button>
            <button onclick="handleInput(')')">)</button>
            <button onclick="deleteChar()">â†’</button>
            <button onclick="clearAll()">C</button>
            <button onclick="handleInput('7')">7</button>
            <button onclick="handleInput('8')">8</button>
            <button onclick="handleInput('9')">9</button>
            <button onclick="handleInput('Ã·')" class="operation">Ã·</button>
            <button onclick="handleInput('4')">4</button>
            <button onclick="handleInput('5')">5</button>
            <button onclick="handleInput('6')">6</button>
            <button onclick="handleInput('Ã—')" class="operation">Ã—</button>
            <button onclick="handleInput('1')">1</button>
            <button onclick="handleInput('2')">2</button>
            <button onclick="handleInput('3')">3</button>
            <button onclick="handleInput('-')" class="operation">âˆ’</button>
            <button onclick="handleInput('0')">0</button>
            <button onclick="handleInput('.')">.</button>
            <button onclick="calculateResult()" class="operation">=</button>
            <button onclick="handleInput('+')" class="operation">+</button>
        </div>
    </div>

<script>
const display = document.getElementById('display');
// ä¿ç•™åŸçŠ¶æ€ç®¡ç†ï¼Œæ— æ”¹åŠ¨
const calculatorState = {
    currentExpr: '',
    isCalculated: false,
    operators: ['+', 'âˆ’', 'Ã—', 'Ã·'], // è¿ç®—ç¬¦ï¼ˆå‡å·æ˜¯âˆ’ï¼‰
    brackets: ['(', ')']
};

// å·¥å…·å‡½æ•°ä¸å˜
function updateDisplay(content) {
    display.innerText = content || '0';
}
function getLastChar() {
    return calculatorState.currentExpr.slice(-1);
}
function getLastNumSegment() {
    return calculatorState.currentExpr.split(/[\+\-\Ã—\Ã·\(\)]/).pop() || '';
}

// ğŸ”´ ä¿®å¤BUG1æ ¸å¿ƒï¼šé‡æ„è¡¨è¾¾å¼è¿‡æ»¤å‡½æ•°ï¼Œä¿ç•™å¼€å¤´è´Ÿå·ï¼ˆåŒºåˆ†è´Ÿæ•°å’Œå‡å·ï¼‰
function filterInvalidExpr(expr) {
    // 1. åªåˆ æ‰å¼€å¤´çš„ +Ã—Ã·ï¼Œä¸åˆ å¼€å¤´ -ï¼ˆè´Ÿæ•°ï¼‰ï¼›ç»“å°¾æ‰€æœ‰è¿ç®—ç¬¦éƒ½åˆ æ‰
    expr = expr.replace(/^[\+\Ã—\Ã·]/, '').replace(/[\+\-\Ã—\Ã·]$/, '');
    // 2. ä¿ç•™åˆæ³•å­—ç¬¦ï¼šæ•°å­—ã€å°æ•°ç‚¹ã€è¿ç®—ç¬¦ã€æ‹¬å·ã€è´Ÿå·ï¼Œè¿‡æ»¤ä¹±ç 
    return expr.replace(/[^\d.\-\+\Ã—\Ã·\(\)]/g, '');
}

// åŸç”Ÿåˆ†æ•°ç²¾å‡†è®¡ç®—æ ¸å¿ƒï¼Œæ— æ”¹åŠ¨ï¼ˆç²¾å‡†æ€§ä¿éšœï¼‰
function gcd(a, b) { return b === 0 ? a : gcd(b, a % b); }
function decimalToFraction(num) {
    if (Number.isInteger(num)) return { num: num, den: 1 };
    let [integer = '0', decimal = ''] = num.toString().split('.');
    const intPart = parseInt(integer);
    const den = Math.pow(10, decimal.length);
    let numTotal = intPart * den + parseInt(decimal || 0);
    const commonDivisor = gcd(numTotal, den);
    return { num: numTotal / commonDivisor, den: den / commonDivisor };
}
function addFraction(a, b) {
    const num = a.num * b.den + b.num * a.den;
    const den = a.den * b.den;
    const g = gcd(num, den);
    return { num: num / g, den: den / g };
}
function subFraction(a, b) {
    const num = a.num * b.den - b.num * a.den;
    const den = a.den * b.den;
    const g = gcd(num, den);
    return { num: num / g, den: den / g };
}
function mulFraction(a, b) {
    const num = a.num * b.num;
    const den = a.den * b.den;
    const g = gcd(num, den);
    return { num: num / g, den: den / g };
}
function divFraction(a, b) {
    const num = a.num * b.den;
    const den = a.den * b.num;
    const g = gcd(num, den);
    return { num: num / g, den: den / g };
}

// ğŸ”´ ä¿®å¤BUG1è¡¥å……ï¼šé‡æ„æ‹¬å·è§£æå‡½æ•°ï¼Œæ”¯æŒæ‹¬å·å†…è´Ÿæ•°
function calcBracket(expr) {
    const bracketReg = /\(([^()]+)\)/g;
    while (bracketReg.test(expr)) {
        expr = expr.replace(bracketReg, (match, inner) => {
            // æ‹¬å·å†…è¡¨è¾¾å¼å…ˆè¿‡æ»¤ï¼Œæ”¯æŒè´Ÿæ•°ï¼ˆæ¯”å¦‚ -2+3ï¼‰
            inner = filterInvalidExpr(inner);
            // ğŸ”´ å…³é”®ï¼šç”¨ä¿®å¤åçš„æ‹†åˆ†å‡½æ•°ï¼Œè§£ææ‹¬å·å†…è´Ÿæ•°
            const { nums: innerNums, ops: innerOps } = splitExprWithNegative(inner);
            if (innerNums.length === 0) return 0;
            
            let res = innerNums[0];
            for (let i = 0; i < innerOps.length; i++) {
                switch (innerOps[i]) {
                    case '+': res += innerNums[i+1]; break;
                    case '-': res -= innerNums[i+1]; break;
                    case '*': res *= innerNums[i+1]; break;
                    case '/': res /= innerNums[i+1]; break;
                }
            }
            return res.toString();
        });
    }
    return expr;
}

// ğŸ”´ ä¿®å¤BUG2æ ¸å¿ƒï¼šæ–°å¢è¡¨è¾¾å¼æ‹†åˆ†å‡½æ•°ï¼Œç²¾å‡†åŒºåˆ†ã€è´Ÿå·ã€‘å’Œã€å‡å·ã€‘ï¼Œè§£å†³5Ã—-2è®¡ç®—é”™è¯¯
// æŠŠè¡¨è¾¾å¼æ‹†æˆ æ•°å­—æ•°ç»„ + è¿ç®—ç¬¦æ•°ç»„ï¼Œæ¯”å¦‚ 5Ã—-2 â†’ nums:[5,-2] ops:['*']
function splitExprWithNegative(expr) {
    // å…ˆæŠŠè®¡ç®—å™¨è¿ç®—ç¬¦ç»Ÿä¸€æ¢æˆJSåŸç”Ÿè¿ç®—ç¬¦ï¼ˆæ–¹ä¾¿è®¡ç®—ï¼šÃ—â†’*ï¼ŒÃ·â†’/ï¼Œâˆ’â†’-ï¼‰
    expr = expr.replace(/Ã—/g, '*').replace(/Ã·/g, '/').replace(/âˆ’/g, '-');
    const nums = [];
    const ops = [];
    let numStr = '';

    for (let i = 0; i < expr.length; i++) {
        const char = expr[i];
        // æ•°å­—/å°æ•°ç‚¹/å¼€å¤´è´Ÿå·/è¿ç®—ç¬¦åè´Ÿå· â†’ å½’ä¸ºæ•°å­—éƒ¨åˆ†
        if (/[\d.]/.test(char) || (char === '-' && (i === 0 || /[\+\-\*\/\(]/.test(expr[i-1])))) {
            numStr += char;
        } 
        // è¿ç®—ç¬¦ â†’ å­˜å…¥è¿ç®—ç¬¦æ•°ç»„ï¼ŒåŒæ—¶æŠŠä¹‹å‰çš„æ•°å­—å­˜å…¥æ•°å­—æ•°ç»„
        else if (/[\+\-\*\/]/.test(char)) {
            if (numStr) {
                nums.push(Number(numStr));
                numStr = '';
            }
            ops.push(char);
        }
    }
    // æœ€åä¸€ä¸ªæ•°å­—å­˜å…¥æ•°ç»„
    if (numStr) nums.push(Number(numStr));
    return { nums, ops };
}

// é‡æ„è§£æå‡½æ•°ï¼Œä½¿ç”¨æ–°çš„æ‹†åˆ†å‡½æ•°ï¼Œæ”¯æŒè´Ÿæ•°è¿ç®—
function parseExpr(expr) {
    // å…ˆå¤„ç†æ‹¬å·ï¼Œå†ç»Ÿä¸€è¿ç®—ç¬¦
    expr = calcBracket(expr);
    expr = expr.replace(/Ã—/g, '*').replace(/Ã·/g, '/').replace(/âˆ’/g, '-');
    // ğŸ”´ ç”¨ä¿®å¤åçš„æ‹†åˆ†å‡½æ•°ï¼Œè·å–å¸¦è´Ÿæ•°çš„æ•°å­—å’Œè¿ç®—ç¬¦
    const { nums, ops } = splitExprWithNegative(expr);
    
    if (nums.length === 0) return { num: 0, den: 1 };
    // è½¬åˆ†æ•°ï¼Œä¿ç•™ç²¾å‡†è®¡ç®—
    let fracs = nums.map(n => decimalToFraction(parseFloat(n)));

    // å…ˆä¹˜é™¤ååŠ å‡é€»è¾‘ä¸å˜ï¼ŒåŸºäºæ‹†åˆ†åçš„æ­£ç¡®æ•°ç»„è®¡ç®—
    let tempNums = [fracs[0]];
    let tempOps = [];
    for (let i = 0; i < ops.length; i++) {
        if (ops[i] === '*' || ops[i] === '/') {
            let prev = tempNums.pop();
            let curr = fracs[i+1];
            tempNums.push(ops[i] === '*' ? mulFraction(prev, curr) : divFraction(prev, curr));
        } else {
            tempNums.push(fracs[i+1]);
            tempOps.push(ops[i]);
        }
    }
    let result = tempNums[0];
    for (let i = 0; i < tempOps.length; i++) {
        result = tempOps[i] === '+' ? addFraction(result, tempNums[i+1]) : subFraction(result, tempNums[i+1]);
    }
    return result;
}

// è¾“å…¥å¤„ç†é€»è¾‘ä¸å˜ï¼Œæ”¯æŒè´Ÿæ•°è¾“å…¥ï¼ˆå¼€å¤´/è¿ç®—ç¬¦å/æ‹¬å·åï¼‰
function handleInput(value) {
    const { currentExpr, isCalculated, operators, brackets } = calculatorState;
    const lastChar = getLastChar();

    if (isCalculated) {
        if (operators.includes(value)) {
            calculatorState.currentExpr = currentExpr + value;
        } else if (brackets.includes(value) || /\d|\./.test(value)) {
            calculatorState.currentExpr = value === '(' ? currentExpr + value : value;
        }
        calculatorState.isCalculated = false;
        updateDisplay(calculatorState.currentExpr);
        return;
    }

    if (value === '.' && getLastNumSegment().includes('.')) return;
    if (value === '-') {
        if (currentExpr === '' || operators.includes(lastChar) || lastChar === '(') {
            calculatorState.currentExpr += '-';
            updateDisplay(calculatorState.currentExpr);
            return;
        }
    }
    if (operators.includes(value) && operators.includes(lastChar)) return;
    if (value === ')' && (operators.includes(lastChar) || lastChar === '(')) return;

    calculatorState.currentExpr += value;
    updateDisplay(calculatorState.currentExpr);
}

// è®¡ç®—ç»“æœé€»è¾‘ï¼Œè°ƒç”¨ä¿®å¤åçš„å‡½æ•°
function calculateResult() {
    try {
        let expr = filterInvalidExpr(calculatorState.currentExpr);
        if (!expr) return;

        const fractionResult = parseExpr(expr);
        const decimalResult = fractionResult.num / fractionResult.den;

        let resStr = decimalResult.toString().replace(/0+$/, '').replace(/\.$/, '');
        if (Math.abs(decimalResult) > 1e12 || (Math.abs(decimalResult) < 1e-6 && decimalResult !== 0)) {
            resStr = decimalResult.toExponential(3);
        }

        calculatorState.currentExpr = resStr;
        calculatorState.isCalculated = true;
        updateDisplay(resStr);
    } catch (err) {
        updateDisplay('é”™è¯¯');
        calculatorState.currentExpr = '';
        calculatorState.isCalculated = false;
    }
}

// åˆ å­—ç¬¦+æ¸…å±ï¼Œæ— æ”¹åŠ¨
function deleteChar() {
    if (calculatorState.isCalculated) {
        calculatorState.currentExpr = '';
        calculatorState.isCalculated = false;
        updateDisplay('0');
        return;
    }
    calculatorState.currentExpr = calculatorState.currentExpr.slice(0, -1);
    updateDisplay(calculatorState.currentExpr);
}
function clearAll() {
    calculatorState.currentExpr = '';
    calculatorState.isCalculated = false;
    updateDisplay('0');
}

// é”®ç›˜ä¼˜åŒ–ä¸å˜ï¼Œæ”¯æŒçº¯é”®ç›˜è¾“å…¥è´Ÿæ•°
document.addEventListener('keydown', (e) => {
    const key = e.key;
    const { operators } = calculatorState;

    if (/[0-9.]/.test(key)) {
        handleInput(key);
        return;
    }

    switch (key) {
        case '+': handleInput('+'); break;
        case '-': handleInput('-'); break;
        case '*': handleInput('Ã—'); break;
        case '/': handleInput('Ã·'); break;
        case '(': handleInput('('); break;
        case ')': handleInput(')'); break;
        case 'Enter': calculateResult(); break;
        case 'Backspace':
        case 'Delete': deleteChar(); break;
        case 'Escape': clearAll(); break;
    }
});
</script>
</body>
</html>