<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂéüÁîüJSÁ≤æÂáÜËÆ°ÁÆóÂô®ÔºàÊó†Á¨¨‰∏âÊñπÂ∫ìÔºâ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f4f4f4;
        }
        .calculator {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            max-width: 400px;
        }
        .display {
            width: 100%;
            height: 60px;
            background-color: #333;
            color: #fff;
            font-size: 32px;
            text-align: right;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            box-sizing: border-box;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-gap: 10px;
        }
        .buttons button {
            width: 100%;
            padding: 20px;
            font-size: 24px;
            border: none;
            border-radius: 5px;
            background-color: #eee;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .buttons button:hover {
            background-color: #ccc;
        }
        .buttons button.operation {
            background-color: #ff8c00;
            color: white;
        }
        .buttons button:active {
            transform: scale(0.98);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="calculator">
        <div class="display" id="display">0</div>
        <div class="buttons">
            <button onclick="input('(')">(</button>
            <button onclick="input(')')">)</button>
            <button onclick="deleteLast()">‚Üí</button>
            <button onclick="clearDisplay()">C</button>
            <button onclick="input('7')">7</button>
            <button onclick="input('8')">8</button>
            <button onclick="input('9')">9</button>
            <button class="operation" onclick="input('√∑')">√∑</button>
            <button onclick="input('4')">4</button>
            <button onclick="input('5')">5</button>
            <button onclick="input('6')">6</button>
            <button class="operation" onclick="input('√ó')">√ó</button>
            <button onclick="input('1')">1</button>
            <button onclick="input('2')">2</button>
            <button onclick="input('3')">3</button>
            <button class="operation" onclick="input('-')">‚àí</button>
            <button onclick="input('0')">0</button>
            <button onclick="input('.')">.</button>
            <button class="operation" onclick="calculate()">=</button>
            <button class="operation" onclick="input('+')">+</button>
        </div>
    </div>

<script>
let display = document.getElementById('display');
window.calcCompleted = false;

// ËæìÂÖ•ÈÄªËæëÔºöÂíå‰Ω†ÂéüÁâàÂÆåÂÖ®‰∏ÄËá¥
function input(value) {
    const currentText = display.innerText;
    if (currentText === 'ÈîôËØØ' || window.calcCompleted) {
        display.innerText = '0';
        window.calcCompleted = false;
    }
    const lastChar = currentText.slice(-1);
    const operators = ['+', '‚àí', '√ó', '√∑'];
    const brackets = ['(', ')'];

    if (currentText === '0') {
        if (value === '.') {
            display.innerText = '0.';
            return;
        }
        if (!brackets.includes(value) && !operators.includes(value)) {
            display.innerText = value;
            return;
        }
    }
    if (operators.includes(value) && operators.includes(lastChar)) return;
    if (value === ')' && (operators.includes(lastChar) || lastChar === '(')) return;
    display.innerText += value;
}

function clearDisplay() { display.innerText = '0'; window.calcCompleted = false; }
function deleteLast() {
    const t = display.innerText;
    if (t === 'ÈîôËØØ' || t.length === 1) {
        display.innerText = '0';
        window.calcCompleted = false;
        return;
    }
    display.innerText = t.slice(0, -1);
    window.calcCompleted = false;
}

// üî• ÂéüÁîüJSÂàÜÊï∞ËøêÁÆóÊ†∏ÂøÉÔºàÂΩªÂ∫ïÊõø‰ª£FractionÂ∫ìÔºåÊó†‰æùËµñÔºâ
// 1. ÊúÄÂ§ßÂÖ¨Á∫¶Êï∞ÔºàÁ∫¶ÂàÜÁî®Ôºâ
function gcd(a, b) {
    return b === 0 ? a : gcd(b, a % b);
}

// 2. Â∞èÊï∞ËΩ¨ÂàÜÊï∞ÔºàËøîÂõû{num:ÂàÜÂ≠ê, den:ÂàÜÊØç}Ôºâ
function decimalToFraction(num) {
    if (Number.isInteger(num)) return { num: num, den: 1 };
    let str = num.toString();
    let [integer, decimal] = str.split('.');
    integer = integer || '0';
    decimal = decimal || '';
    
    const intPart = parseInt(integer);
    const decLen = decimal.length;
    const decPart = parseInt(decimal);
    const den = Math.pow(10, decLen);
    let numTotal = intPart * den + decPart;

    // Á∫¶ÂàÜ
    const commonDivisor = gcd(numTotal, den);
    return {
        num: numTotal / commonDivisor,
        den: den / commonDivisor
    };
}

// 3. ÂàÜÊï∞Âä†Ê≥ï
function addFraction(a, b) {
    const num = a.num * b.den + b.num * a.den;
    const den = a.den * b.den;
    const g = gcd(num, den);
    return { num: num / g, den: den / g };
}

// 4. ÂàÜÊï∞ÂáèÊ≥ï
function subFraction(a, b) {
    const num = a.num * b.den - b.num * a.den;
    const den = a.den * b.den;
    const g = gcd(num, den);
    return { num: num / g, den: den / g };
}

// 5. ÂàÜÊï∞‰πòÊ≥ï
function mulFraction(a, b) {
    const num = a.num * b.num;
    const den = a.den * b.den;
    const g = gcd(num, den);
    return { num: num / g, den: den / g };
}

// 6. ÂàÜÊï∞Èô§Ê≥ï
function divFraction(a, b) {
    const num = a.num * b.den;
    const den = a.den * b.num;
    const g = gcd(num, den);
    return { num: num / g, den: den / g };
}

// 7. Ëß£ÊûêË°®ËææÂºèÔºà‰ªÖÊîØÊåÅ Êï∞Â≠ó+ÂõõÂàôËøêÁÆóÔºåÊó•Â∏∏Â§üÁî®Ôºâ
function parseExpr(expr) {
    // ÊõøÊç¢Á¨¶Âè∑+ÂÖºÂÆπÁÆÄÂÜô‰πòÊ≥ï
    expr = expr.replace(/√ó/g, '*').replace(/√∑/g, '/').replace(/‚àí/g, '-').replace(/(\d)\(/g, '$1*(');
    // ÊãÜÂàÜÊï∞Â≠óÂíåËøêÁÆóÁ¨¶ÔºàÁÆÄÂçïÊãÜÂàÜÔºåÈÄÇÈÖçÂü∫Á°ÄËøêÁÆóÔºâ
    const nums = expr.split(/[\+\-\*\/]/).filter(n => n);
    const ops = expr.match(/[\+\-\*\/]/g) || [];
    
    // ËΩ¨ÂàÜÊï∞Êï∞ÁªÑ
    const fracs = nums.map(n => decimalToFraction(parseFloat(n)));
    if (fracs.length === 0) return { num: 0, den: 1 };
    
    // ÈÄêÊ¨°ËøêÁÆó
    let result = fracs[0];
    for (let i = 0; i < ops.length; i++) {
        switch (ops[i]) {
            case '+': result = addFraction(result, fracs[i+1]); break;
            case '-': result = subFraction(result, fracs[i+1]); break;
            case '*': result = mulFraction(result, fracs[i+1]); break;
            case '/': result = divFraction(result, fracs[i+1]); break;
        }
    }
    return result;
}

// Ê†∏ÂøÉËÆ°ÁÆóÔºöÂéüÁîüÂàÜÊï∞ËøêÁÆóÔºå0.1+0.2ÁªùÂØπÁ≤æÂáÜ
function calculate() {
    try {
        const expr = display.innerText;
        const fractionResult = parseExpr(expr);
        const decimalResult = fractionResult.num / fractionResult.den;
        
        // ÊòæÁ§∫‰ºòÂåñÔºöÂéªÊú´Â∞æ0ÂíåÂ∞èÊï∞ÁÇπ
        let resStr = decimalResult.toString().replace(/0+$/, '').replace(/\.$/, '');
        if (Math.abs(decimalResult) > 1e12 || (Math.abs(decimalResult) < 1e-6 && decimalResult !== 0)) {
            resStr = decimalResult.toExponential(3);
        }
        display.innerText = resStr;
        window.calcCompleted = true;
    } catch (err) {
        display.innerText = 'ÈîôËØØ';
        window.calcCompleted = true;
    }
}

// ÈîÆÁõòÊîØÊåÅ‰∏çÂèò
document.addEventListener('keydown', e => {
    const k = e.key;
    if (/[0-9.]/.test(k)) { input(k); return; }
    switch(k) {
        case '+':input('+');break;case '-':input('‚àí');break;case '*':input('√ó');break;case '/':input('√∑');break;
        case '(':input('(');break;case ')':input(')');break;case 'Enter':e.preventDefault();calculate();break;
        case 'Backspace':deleteLast();break;case 'Escape':clearDisplay();break;
    }
});
</script>
</body>
</html>