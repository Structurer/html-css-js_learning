<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ¬åœ°å“ˆå¸Œè®¡ç®—å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        body {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background: #f5f5f5;
        }
        .container {
            gap: 20px;
            display: flex;
            flex-direction: column;
        }
        .title {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
        }
        .section {
            background: #fff;
            padding: 18px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section h3 {
            color: #444;
            margin-bottom: 12px;
            font-size: 16px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        /* æ–‡æœ¬è¾“å…¥åŒº */
        #textInput {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-size: 14px;
        }
        /* ç®—æ³•é€‰æ‹©åŒº */
        .algo-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 8px;
        }
        .algo-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
        }
        /* æ‹–æ‹½åŒº */
        .drag-area {
            width: 100%;
            height: 160px;
            border: 2px dashed #ccc;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
        }
        .drag-area.active {
            border-color: #2196F3;
            background: #f0f8ff;
            color: #2196F3;
        }
        .drag-area p {
            text-align: center;
            font-size: 14px;
            line-height: 1.5;
        }
        /* è¾“å‡ºåŒº */
        #resultOutput {
            width: 100%;
            height: 300px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-size: 13px;
            line-height: 1.4;
            background: #fafafa;
            white-space: pre-wrap;
            overflow-y: auto;
        }
        /* æŒ‰é’®åŒº */
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: #2196F3;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        button:hover {
            background: #1976D2;
        }
        button.clear {
            background: #f44336;
        }
        button.clear:hover {
            background: #d32f2f;
        }
        button.copy {
            background: #4CAF50;
        }
        button.copy:hover {
            background: #388E3C;
        }
        /* åŠ è½½æç¤º */
        .loading {
            color: #2196F3;
            font-size: 14px;
            text-align: center;
            display: none;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="title">æœ¬åœ°å“ˆå¸Œè®¡ç®—å·¥å…·ï¼ˆæ–‡ä»¶/æ–‡ä»¶å¤¹/æ–‡æœ¬ï¼‰</h2>

        <!-- 1. æ–‡æœ¬è¾“å…¥åŒº -->
        <div class="section">
            <h3>ä¸€ã€ æ–‡æœ¬å“ˆå¸Œè¾“å…¥</h3>
            <textarea id="textInput" placeholder="è¾“å…¥ä»»æ„æ–‡å­—ï¼Œå¯è®¡ç®—å¯¹åº”å“ˆå¸Œå€¼..."></textarea>
        </div>

        <!-- 2. å“ˆå¸Œç®—æ³•é€‰æ‹©åŒº -->
        <div class="section">
            <h3>äºŒã€ é€‰æ‹©å“ˆå¸Œç®—æ³•ï¼ˆæ”¯æŒå¤šé€‰ï¼‰</h3>
            <div class="algo-group">
                <!-- å¸¸ç”¨ç®—æ³• -->
                <label class="algo-item"><input type="checkbox" name="algo" value="MD5" checked> MD5</label>
                <label class="algo-item"><input type="checkbox" name="algo" value="SHA-1"> SHA-1</label>
                <label class="algo-item"><input type="checkbox" name="algo" value="SHA-256" checked> SHA-256</label>
                <label class="algo-item"><input type="checkbox" name="algo" value="SHA-384"> SHA-384</label>
                <label class="algo-item"><input type="checkbox" name="algo" value="SHA-512" checked> SHA-512</label>
                <!-- å°ä¼—SHA3ç³»åˆ—ç®—æ³• -->
                <label class="algo-item"><input type="checkbox" name="algo" value="SHA-3-256"> SHA-3-256</label>
                <label class="algo-item"><input type="checkbox" name="algo" value="SHA-3-384"> SHA-3-384</label>
                <label class="algo-item"><input type="checkbox" name="algo" value="SHA-3-512"> SHA-3-512</label>
            </div>
        </div>

        <!-- 3. æ‹–æ‹½æ–‡ä»¶/æ–‡ä»¶å¤¹åŒº -->
        <div class="section">
            <h3>ä¸‰ã€ æ‹–æ‹½æ–‡ä»¶/æ–‡ä»¶å¤¹ï¼ˆæ”¯æŒå¤šæ–‡ä»¶/é€’å½’æ–‡ä»¶å¤¹ï¼‰</h3>
            <div id="dragArea" class="drag-area">
                <p>ğŸ–±ï¸ æ‹–æ‹½æ–‡ä»¶/æ–‡ä»¶å¤¹åˆ°æ­¤å¤„</p>
                <p>æ”¯æŒå•æ–‡ä»¶/å¤šæ–‡ä»¶/æ•´ä¸ªæ–‡ä»¶å¤¹ï¼Œæ–‡ä»¶å¤¹è‡ªåŠ¨é€’å½’éå†æ‰€æœ‰å­æ–‡ä»¶</p>
            </div>
        </div>

        <!-- 4. æ“ä½œæŒ‰é’®+åŠ è½½æç¤º -->
        <div class="btn-group">
            <button id="calcBtn">å¼€å§‹è®¡ç®—å“ˆå¸Œ</button>
            <button id="copyBtn" class="copy">å¤åˆ¶å…¨éƒ¨ç»“æœ</button>
            <button id="clearBtn" class="clear">æ¸…ç©ºæ‰€æœ‰å†…å®¹</button>
        </div>
        <div class="loading" id="loading">è®¡ç®—ä¸­... å¤§æ–‡ä»¶/æ–‡ä»¶å¤¹è¯·ç¨å€™</div>

        <!-- 5. ç»“æœè¾“å‡ºåŒº -->
        <div class="section">
            <h3>å››ã€ å“ˆå¸Œè®¡ç®—ç»“æœï¼ˆæœ¬åœ°è®¡ç®—ï¼Œæ— æ–‡ä»¶ä¸Šä¼ ï¼‰</h3>
            <textarea id="resultOutput" readonly placeholder="è®¡ç®—ç»“æœå°†å±•ç¤ºåœ¨è¿™é‡Œ..."></textarea>
        </div>
    </div>

    <script>
        // å…¨å±€DOMè·å–
        const textInput = document.getElementById('textInput');
        const dragArea = document.getElementById('dragArea');
        const resultOutput = document.getElementById('resultOutput');
        const calcBtn = document.getElementById('calcBtn');
        const copyBtn = document.getElementById('copyBtn');
        const clearBtn = document.getElementById('clearBtn');
        const loading = document.getElementById('loading');
        const algoCheckboxes = document.querySelectorAll('input[name="algo"]');

        // å­˜å‚¨æ‹–æ‹½çš„æ–‡ä»¶åˆ—è¡¨ï¼ˆå®Œæ•´è·¯å¾„+æ–‡ä»¶å¯¹è±¡ï¼‰
        let fileList = [];

        // ========== æ ¸å¿ƒå·¥å…·å‡½æ•° ==========
        // 1. ArrayBufferè½¬åå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼ˆæ‰€æœ‰ç®—æ³•é€šç”¨ï¼‰
        function arrayBufferToHex(buffer) {
            return Array.from(new Uint8Array(buffer))
                .map(byte => byte.toString(16).padStart(2, '0'))
                .join('');
        }

        // 2. è·å–é€‰ä¸­çš„å“ˆå¸Œç®—æ³•
        function getSelectedAlgos() {
            return Array.from(algoCheckboxes).filter(box => box.checked).map(box => box.value);
        }

        // 3. é€šç”¨å“ˆå¸Œè®¡ç®—å‡½æ•°ï¼ˆæ–‡æœ¬/æ–‡ä»¶é€šç”¨ï¼‰
        async function calculateHash(data, algo) {
            try {
                const buffer = await window.crypto.subtle.digest(algo, data);
                return arrayBufferToHex(buffer);
            } catch (e) {
                return `ç®—æ³•${algo}è®¡ç®—å¤±è´¥ï¼š${e.message}`;
            }
        }

        // ========== æ–‡æœ¬å“ˆå¸Œè®¡ç®— ==========
        async function calcTextHash(text) {
            if (!text.trim()) return '';
            const algos = getSelectedAlgos();
            if (algos.length === 0) return 'è¯·è‡³å°‘é€‰æ‹©ä¸€ç§å“ˆå¸Œç®—æ³•ï¼';
            
            const encoder = new TextEncoder();
            const data = encoder.encode(text.trim());
            let result = `ã€æ–‡æœ¬å“ˆå¸Œã€‘è¾“å…¥å†…å®¹ï¼š${text.trim()}\n`;
            
            for (const algo of algos) {
                const hash = await calculateHash(data, algo);
                result += `â””â”€â”€ ${algo}ï¼š${hash}\n`;
            }
            return result + '\n';
        }

        // ========== æ–‡ä»¶/æ–‡ä»¶å¤¹å¤„ç† ==========
        // 1. é€’å½’éå†æ–‡ä»¶å¤¹ï¼Œè·å–æ‰€æœ‰æ–‡ä»¶ï¼ˆå«å­æ–‡ä»¶å¤¹ï¼‰
        async function traverseFolder(entry, path = '') {
            const fullPath = path ? `${path}/${entry.name}` : entry.name;
            if (entry.isFile) {
                return new Promise(resolve => {
                    entry.file(file => {
                        fileList.push({ path: fullPath, file });
                        resolve();
                    });
                });
            } else if (entry.isDirectory) {
                const reader = entry.createReader();
                return new Promise(resolve => {
                    const readEntries = () => {
                        reader.readEntries(entries => {
                            if (entries.length === 0) {
                                resolve();
                                return;
                            }
                            Promise.all(entries.map(e => traverseFolder(e, fullPath))).then(readEntries);
                        });
                    };
                    readEntries();
                });
            }
        }

        // 2. è®¡ç®—å•ä¸ªæ–‡ä»¶å“ˆå¸Œ
        async function calcFileHash(fileItem) {
            const { path, file } = fileItem;
            const algos = getSelectedAlgos();
            let result = `ã€æ–‡ä»¶å“ˆå¸Œã€‘å®Œæ•´è·¯å¾„ï¼š${path}\n`;
            
            const reader = new FileReader();
            return new Promise(resolve => {
                reader.onload = async () => {
                    const data = reader.result;
                    for (const algo of algos) {
                        const hash = await calculateHash(data, algo);
                        result += `â””â”€â”€ ${algo}ï¼š${hash}\n`;
                    }
                    resolve(result + '\n');
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // 3. æ‰¹é‡è®¡ç®—æ–‡ä»¶å“ˆå¸Œï¼ˆå«æ–‡ä»¶å¤¹é€’å½’ï¼‰
        async function calcFilesHash() {
            if (fileList.length === 0) return '';
            let result = `ã€æ‰¹é‡æ–‡ä»¶å“ˆå¸Œã€‘å…±${fileList.length}ä¸ªæ–‡ä»¶\n`;
            for (const fileItem of fileList) {
                result += await calcFileHash(fileItem);
            }
            return result;
        }

        // ========== æ‹–æ‹½åŠŸèƒ½å®ç° ==========
        // æ‹–æ‹½æ‚¬æµ®
        dragArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dragArea.classList.add('active');
        });
        // æ‹–æ‹½ç¦»å¼€
        dragArea.addEventListener('dragleave', () => {
            dragArea.classList.remove('active');
        });
        // æ‹–æ‹½æ”¾ä¸‹
        dragArea.addEventListener('drop', async (e) => {
            e.preventDefault();
            dragArea.classList.remove('active');
            fileList = []; // æ¸…ç©ºæ—§æ–‡ä»¶åˆ—è¡¨

            const items = e.dataTransfer.items;
            if (!items.length) return;

            // è§£ææ‹–æ‹½çš„æ–‡ä»¶/æ–‡ä»¶å¤¹
            for (const item of items) {
                const entry = item.webkitGetAsEntry();
                if (entry) await traverseFolder(entry);
            }

            // æç¤ºæ‹–æ‹½ç»“æœ
            if (fileList.length > 0) {
                resultOutput.value += `å·²æˆåŠŸè¯†åˆ«ï¼š${fileList.length}ä¸ªæ–‡ä»¶ï¼ˆå«é€’å½’æ–‡ä»¶å¤¹å†…æ–‡ä»¶ï¼‰\n\n`;
            }
        });

        // ========== æŒ‰é’®ç‚¹å‡»äº‹ä»¶ ==========
        // å¼€å§‹è®¡ç®—
        calcBtn.addEventListener('click', async () => {
            loading.style.display = 'block';
            resultOutput.value = '';
            let finalResult = '';

            // 1. è®¡ç®—æ–‡æœ¬å“ˆå¸Œï¼ˆæœ‰è¾“å…¥æ‰è®¡ç®—ï¼‰
            if (textInput.value.trim()) {
                finalResult += await calcTextHash(textInput.value);
            }

            // 2. è®¡ç®—æ–‡ä»¶å“ˆå¸Œï¼ˆæœ‰æ–‡ä»¶æ‰è®¡ç®—ï¼‰
            if (fileList.length > 0) {
                finalResult += await calcFilesHash();
            }

            // æ— è¾“å…¥æç¤º
            if (!finalResult) {
                finalResult = 'è¯·è¾“å…¥æ–‡æœ¬ æˆ– æ‹–æ‹½æ–‡ä»¶/æ–‡ä»¶å¤¹åå†è®¡ç®—ï¼';
            }

            resultOutput.value = finalResult;
            loading.style.display = 'none';
        });

        // å¤åˆ¶ç»“æœ
        copyBtn.addEventListener('click', async () => {
            if (!resultOutput.value.trim()) return;
            await navigator.clipboard.writeText(resultOutput.value);
            alert('ç»“æœå·²æˆåŠŸå¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        });

        // æ¸…ç©ºæ‰€æœ‰
        clearBtn.addEventListener('click', () => {
            textInput.value = '';
            resultOutput.value = '';
            fileList = [];
            algoCheckboxes.forEach(box => box.checked = box.value === 'MD5' || box.value === 'SHA-256' || box.value === 'SHA-512');
        });
    </script>
</body>
</html>